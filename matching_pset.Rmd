---
title: 'Problem Set #2'
author: "Jules Tucher"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen = 999)

# load libraries
library(tidyverse)
library(rgenoud)
library(Matching)

# set local directory and open analysis datafile
root_dir <- getwd()
cleaned_data_std_outcomes <- readRDS(file.path(root_dir, "Intermediate data files", "cleaned_data_std_outcomes.RDS"))

# drop if missing treatment or outcome
analysis_data <- cleaned_data_std_outcomes %>%
  filter(!is.na(treatment), !is.na(overalllifesat))
  
# pull random sample to reduce complexity (10%)
matching_sample <- dplyr::slice_sample(analysis_data, prop=0.1)
```

## Please briefly discuss why you chose these data and what they contain. Also, please identify and discuss the “outcome” and “treatment” variables of interest to you.

I chose these data because it's the same dataset that I am working with for my replication final paper for this class. The data is at the couple level, with covariates for both the husband and the wife in a heterosexual marriage. The treatment variable is a binary indicator variable representing whether the wife out-earns the husband. The outcome variable for this assignment is overall life satisfaction.

```{r}

# summarize treatment variable
matching_sample %>%
  dplyr::summarize(
    across(
      all_of(c("treatment")),
      list(mean = mean, sd = sd),
      .names = "{.col}_{.fn}"
      ),
    n=n()
  )

```
From the summary, we can see that around 16% of the sample (N = 78,735) is in the treatment group (i.e. where the wife outearns the husband). Since the sample is so imbalanced on the treatment variable, may need to implement many-to-one matching.

## Then, explain which variables are included in your balance and/or X matrices and why. Describe the settings you chose for the various GenMatch arguments (e.g. what estimand have you selected and why?).

Variables included for balance are the covariates we are interested in for the RDD: wage, age, number of children, and whether the husband has a college degree. See the following distributions for those four variables.

```{r matching-vars}

# store names of covariate variables
covs = c("age", "wage", "nchildren", "college")

# summarize matching variables
matching_sample %>%
  
  # generate mean and SD of each matching variable for full sample
  dplyr::summarize(
    across(
      all_of(covs),
      list(min=min, mean=mean, max=max),
      .names = "{.col}_{.fn}"
      )
  ) %>%
  
  # reshape for readibility
  pivot_longer(everything()) %>%
  separate(col = "name", into = c("variable", "stat"), sep = "_") %>%
  pivot_wider(id_cols = "variable", names_from = "stat")

```

```{r genmatch}

# treatment vector
t = as.vector(matching_sample %>% dplyr::select(treatment))$treatment

# covariate matrix
X = as.matrix(matching_sample %>% dplyr::select(all_of(covs)))

# weights vector from data sources
weights = as.vector(matching_sample %>% dplyr::select(phrf))

# run matching algorithm for weights
genout = GenMatch(Tr = t,
           X = X,
           estimand = "ATE",
           M = 1,
           pop.size = 20,
           max.generations = 3,
           wait.generations = 1,
           replace = TRUE,
           ties = TRUE,
           hard.generation.limit = TRUE,
           print.level = 1)

# use match to calculate estimand
mout <- Match(
  Y = matching_sample$overalllifesat,
  Tr = t,
  X = X,
  Weight.matrix = genout,
  estimand = "ATE",
  M = 1
)

mout
```



## Present your key balance metrics both numerically and graphically (e.g. Q-Q plots or t-test plots). Was there improvement?

```{r numeric-balance}
mb <- MatchBalance(
  treatment ~ age + wage + nchildren + college,
  data = matching_sample,
  match.out = mout
)

mb

```

```{r graphical-balance-before}
par(mfrow = c(2,2))

sample_treated = matching_sample %>%
  filter(treatment = )
for (cov in covs) {
  # pull out covariate values from before
  x_treated <- matching_sample[matching_sample$treatment == 1, cov]
  x_control <- matching_sample[[cov]][matching_sample$treatment]
  
  qqplot(x_control,
         x_treated,
         xlab = "Control",
         ylab = "Treated",
         main = paste("QQ plot for covariate:", cov))
  abline(0, 1, col = "blue", lty = 2)
}
par(mfrow = c(1,1))

```
```{r graphical-balance-after}

par(mfrow = c(2,2))
for (cov in covs) {
  x_treated <- matching_sample[[cov]][mout$index.treated]
  x_control <- matching_sample[[cov]][mout$index.control]
  
  qqplot(x_control,
         x_treated,
         xlab = "Control",
         ylab = "Treated",
         main = paste("QQ plot for covariate:", cov))
  abline(0, 1, col = "blue", lty = 2)
}
par(mfrow = c(1,1))
```

## Did you find a treatment effect? Was this finding different from what you find without matching?

