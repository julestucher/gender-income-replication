---
title: "Replication: Relative income within the household, gender norms, and well-being"
author: "Jules Tucher"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(haven)
library(rdrobust)
library(fixest)
library(knitr)
library(kableExtra)

# set local directory and open analysis datafile
root_dir <- getwd()
analysis_data <- readRDS(file.path(root_dir, "Intermediate data files", "analysis_data.RDS")) 
```

# Introduction and Background

The article for my replication, “Relative income within the household, gender norms, and well-being,” is a 2024 study that uses regression discontinuity design on longitudinal observation data to examine the effects of women out-earning their husbands on overall life satisfaction and health outcomes (Gihleb, et al. 2024). It explores the differences in results between East and West Germany, where social norms about women's participation in the workforce differs. The replication package includes a Stata dataset and two Stata program files to replicate the main findings in the paper. The raw data is not included, but instead a clean analysis file that includes the constructs from the analysis.
For my final project, I suggest replicating the main figures from the paper, as well as performing the two RD analyses. My replication paper would also add a discussion about the causal claim made by the original article, specifically the assumptions and limitations of the methods employed, as the original article does not discuss causal inference in depth. As I continue to work on the project, I may also explore additional analyses to perform.

## Research Hypothesis

Although the research team does not explicitly state their hypotheses in the published article, I would state the null hypothesis as relative income has no effect on the satisfaction and mental and physical health of men and women in Germany. The confirmatory hypothesis of the study is that women earning more than their husbands causes people to be less satisfied with their lives, with a theoretical framing based on cultural and gender norms that expect men to be the breadwinners. Exploratory hypotheses investigate the moderating effect of region on this causal relationship, based on an understanding of the differing cultural and gender norms in East and West Germany. Because it became more normalized for women to enter the work force during the Cold War in East Germany, cultural values shifted toward more equal work expectations of men and women. 

# Methods

## Discription of the Data
The replication dataset provided by the research team is at the couple-level, with values for the male and female members of the heterosexual couple. The unit of analysis is the couple. The population is married adults in Germany. This observational data was collected from the German Socioeconomic Panel (GSOEP), a longitudinal socioeconomic survey. The methods employ a regression discontinuity design, comparing outcomes between couples where women just outearn their husbands. Therefore, the explanatory variable is the difference in income between the two members of the couple. The outcomes of interest include satisfaction with life, health, and work, as well as physical and mental health ratings. Finally, the research team was interested in regional differences between East and West Germany, specifically as associated with different cultural and gender norms in the two regions.

## Quantitative Measures
Unfortunately, the replication dataset provided includes pre-calculated constructs and not the raw variables, so I cannot replicate variable construction and dataset aggregation. Furthermore, the raw data, although publicly available, requires an application process to obtain. However, the authors do describe their operationalization strategies. First, the three satisfaction variables (life, work, and health) are constructed based on survey questions on an 11-point Likert scale. No other construction details are provided, so I plan to explore the data to see if the variables are averages or have been normalized. The other two outcome variables in the main analysis, mental and physical health, are pulled from the 12-Item Short Form Health Survey, a subsurvey of the GSOEP administered every 2 years. The 12 questions are asked on the 0 to 100 scale, and converted to averages and standardized for this analysis. As for the treatment variable, wages and salaries for both members of the couple were collected to calculate a difference. Other covariates include region (East/West), number of children, age, and education. These variables were measured in the first year of marriage.

## Estimation Procedure
This study implements an RDD analysis to estimate the local average treatment effect (LATE) using OLS linear regression. The model is specified as:
$$Y_{iht}=\beta_1I[E_{iht}^{Wife}\ge E_{iht}^{Husband}] + \beta_2(E_{iht}^{Wife}-E_{iht}^{Husband})+\beta_3(E_{iht}^{Wife}-E_{iht}^{Husband})*I[E_{iht}^{Wife}\ge E_{iht}^{Husband}]+\epsilon_{iht}+\eta_i$$
Here, `Y` is the metric of well-being or health, $E_{iht}^{Wife}-E_{iht}^{Husband}$ is the running variable constructed for the treatment, $\beta_1$ is the coefficient of interest, $\eta_i$ represents the fixed effects at the individual level, and $\epsilon_{iht}$ is the couple-level error term. Controls are omitted from this equation but present in the OLS model.

## Power Analysis 

Since we are interested in a single regression coefficient for each predictor, we can use the “power.t.regression” function from the “pwrss” package in R to run our power analysis. I set the expected coefficient to -0.05, which is a similar magnitude to the coefficients in the published paper. Since focus is on a single predictor, I also provide the power analysis algorithm with SD of the predictor of interest and each outcome variable and set an R^2 computationally based on the other parameters. I am interested in an 80% powered experiment with an alpha of 0.05, which means an 80% probability of rejecting the null with a 5% chance of a type 1 error. See code sample below.
Running this function on each of the 5 outcomes in the main analysis, sample size required for the design is between 5,000 and 6,000. Given that there are around 76,000 couples in the sample, the data provided should be sufficient given the design. In my final project, I will also consider adjusting p-values to incorporate concerns about multiple, correlated outcomes on the same data.

```{r power-analysis}
#install.packages("pwrss")
library(pwrss)

sds <- analysis_data %>%
  select(all_of(c(outcomes, "recode_diff_wage_OR", "recode_diff_wage_OR_int", "recode_diff_wage"))) %>%
  filter(recode_diff_wage_OR < 19, recode_diff_wage_OR > -19) %>%
  summarize_all(~mean(.x, na.rm=T))

for(var in outcomes) {
  print(var)
  sd.out <- sds %>% select(matches(var)) %>% as.numeric()
  sd.pred <- sds %>% select(recode_diff_wage_OR) %>% as.numeric()
  beta = ifelse(str_detect(var, "std"), 0.005, 0.05)
  power.t.regression(beta = beta, # expected coefficient
                     sd.predictor = sd.pred,
                     sd.outcome = sd.out, 
                     k.total = 7, # total number of predictors
                     r.squared = (beta * sd.pred / sd.out)^2,
                     power = 0.95, # no default, probability of correctly rejecting the null
                     alpha = 0.05, # probability of type 1 error
                     alternative = "two.sided")
  }

```

# Results

## Running Variable: Wife-Husband Wage Difference
```{r rv-histogram}
# full data histogram
analysis_data %>%
  ggplot(aes(x=recode_diff_wage_OR)) +
    geom_histogram(aes(y = ..density..), binwidth=20, boundary=0, fill="#69b3a2", color="#e9ecef", alpha=0.9) +
    ggtitle(paste0("Running variable density for full data sample (N = ", format(nrow(data_std_outcomes), big.mark=","), ")")) +
    theme_minimal() +
    xlab("Wife-Husband Wage Difference") +
    theme(
      plot.title = element_text(size=15)
    ) +
    geom_vline(aes(xintercept = 0), color = "black", linetype = "dashed", linewidth = 1)
```
The above histogram depicts the distribution of the running variable across the entire dataset.
```{r histogram-threshold}
# restrict to within 20k of threshold
threshold_data <- analysis_data %>%
  filter(abs(recode_diff_wage_OR) < 20)

threshold_data %>%
  ggplot(aes(x=recode_diff_wage_OR)) +
    geom_histogram(aes(y = ..density..), boundary = 0, binwidth=2, fill="#69b3a2", color="#e9ecef", alpha=0.9) +
    ggtitle(paste0("Running variable density within 20k of threshold (N = ", format(nrow(threshold_data), big.mark=","), ")")) +
    theme_minimal() +
    theme(
      plot.title = element_text(size=15)
    ) +
    xlab("Wife-Husband Wage Difference") +
    ylab("Proportion of Sample") +
    geom_vline(aes(xintercept = 0), color = "black", linetype = "dashed", linewidth = 1)

```
The above histogram depicts the distribution of the running variable for those observation whose running variable is within $20,000 of the threshold. In these cases, husband-wife earning difference is between 0 and 20,000. This threshold was selected to reflect the data as presented in Fig. 1 of the original publication. However, this results in a 40% decrease in sample size.

## Implementing the model in R
```{r rd-model}
# outcome residuals
outcomes = c("overalllifesat", "worksat", "m11125", "std_mcs", "std_pcs", "overalllifesat_female", "worksat_female", "m11125_female", "std_mcs_female", "std_pcs_female")

# store covariate data (consistent across outcomes)
male_covs = analysis_data %>%
  select(all_of(c("age", "wage", "nchildren", "college"))) %>%
  as.matrix()

# store female covs
female_covs = analysis_data %>%
  select(all_of(c("age", "wage_female", "nchildren_female", "college_female"))) %>%
  as.matrix()
           
# set threshold to 0 and pull out running variable
threshold <- 0.00001
running_var <- analysis_data$recode_diff_wage_OR

results <- list()
plots <- list()
for (outcome in outcomes) {
  
  covs <- if (grepl("female", outcome)) female_covs else male_covs
  
  # rdrobust: outcome ~ running | cutoff, clustered SE
  rd <- rdrobust(y = analysis_data[[paste0(outcome, "_res")]],
                 x = running_var, 
                 c = threshold,
                 covs = covs, # controls
                 bwselect = "mserd", # use MSE selection criteria
                 cluster = analysis_data$recode_diff_wage_OR_int # integer version of RV
                 )
  
  # get sample used in RD so we can report stats (non-missing outcome and within benchmark)
  rd_sample <- !is.na(analysis_data[[paste0(outcome, "_res")]]) &
                ifelse(running_var <= threshold, 
                      abs(running_var - threshold) <= rd$bws["h","left"], # left bandwidth
                      abs(running_var - threshold) <= rd$bws["h","right"]) # right bandwidth
  rd_effective_data <- analysis_data[rd_sample,]
  
  # store results for later table
  results[[outcome]] <- list(
    rd_effect = rd$coef[3], # pull robust effect estimate, error, and pval
    rd_error = rd$se[3],
    rd_pval = rd$pv[3],
    n_effective = nrow(rd_effective_data),
    y_mean =  mean(rd_effective_data[[outcome]]),
    y_sd = sd(rd_effective_data[[outcome]])
  )
  
  # create RD plots (for lifesat and health)
  if (grepl("overalllifesat", outcome) | grepl("female", outcome)) {
    analysis_data
    plots[[outcome]] 
    
    rdplot(
          y = rd_effective_data[[paste0(outcome, "_res")]],
          x = rd_effective_data$recode_diff_wage_OR,
          nbins = 3,
          h = rd$bws["h",],
          p = 1,
          covs = male_covs,
          ci = TRUE
        )
  }
}

range(rd_effective_data$recode_diff_wage_OR)
any(is.na(rd_effective_data$recode_diff_wage_OR))
is.na(threshold)
```

## Replicating Figure 2: Gender norms, well-being and health, men.
```{r fig-2}
rdplot_lifesat
```

## Replicating Figure 3: Gender norms, well-being and health, women.

## Replicating Table 1

```{r table-1}
# convert results to a table that we like
results %>%
  # combine results for all models
  lapply(as.data.frame) %>%
  bind_rows() %>%
  mutate(outcome = outcomes) %>%
  
  # add gender column, p-value sig stars, and combine values for final RD expression
  separate(outcome, into = c("outcome", "gender"), fill = "right", sep = "_female") %>%
  mutate(pstar = ifelse(rd_pval < 0.01, "***",
                        ifelse(rd_pval < 0.05, "**",
                               ifelse(rd_pval < 0.1, "*", "")))) %>%
  mutate(gender = ifelse(is.na(gender), "male", "female"),
         rd_effect = paste0(round(rd_effect, 3), pstar),
         rd_error = paste0("(", round(rd_error, 3), ")"),
         n_effective = paste(format(n_effective, big.mark=","))
         ) %>%
  
  # format estimates
  mutate(
    across(
      all_of(c("y_mean", "y_sd")),
      ~paste(round(.x, 3))
    )
  ) %>%
  
  # reshape so columns are each model
  select(-all_of(c("rd_pval", "pstar"))) %>%
  pivot_longer(cols = -c("outcome", "gender")) %>%
  pivot_wider(id_cols = c("gender", "name"), names_from = "outcome") %>%
  
  # order rows and label
  mutate(name = factor(name, levels = c("rd_effect", "rd_error", "n_effective", "y_mean", "y_sd")),
         gender = factor(gender, levels = c("male", "female"))) %>%
  arrange(gender, name) %>%
  mutate(name = rep(c("RDD wife earns more", "", "Observations (effective)", "Mean of dep. var.", "SD of dep. var."), 2)) %>%
  select(-gender) %>%
  
  # final kable
  kable(
    format = "html",
    col.names = c("", "Satisfaction with life", "Satisfaction with work",
                  "Satisfaction with health", "Mental health", "Physical health"),
    align = c("l", rep('c', 5)),
    escape = FALSE
  ) %>%
  kableExtra::add_header_above(
    header = c(" " = 1, "Dependent variable" = 5)
  ) %>%
  kableExtra::group_rows("Panel A: Male", 1, 5) %>%
  kableExtra::group_rows("Panel B: Female", 6, 10) 

```
No age variable for wife included in the replication data set.

## Replicating Table 2

```{r rd-model-west}

# create analysis dataset for region-specific model
analysis_data_west <- analysis_data %>%
  mutate(
    # region * treatment
    west_treatment = west * treatment
  )


# store covariate data (consistent across outcomes)
male_covs_west = analysis_data_west %>%
  select(all_of(c("age", "wage", "nchildren", "college", "west_treatment", "west"))) %>%
  as.matrix()

# store female covs
female_covs = analysis_data_west %>%
  select(all_of(c("age", "wage_female", "nchildren_female", "college_female", "west_treatment", "west"))) %>%
  as.matrix()
           
# set threshold to 0 and pull out running variable
threshold <- 0.00001
running_var <- analysis_data_west$recode_diff_wage_OR

results_west <- list()
for (outcome in outcomes) {
  
  # set gender-dependent covariates
  covs <- ifelse(grepl("female", outcome), female_covs, male_covs)

  # rdrobust: outcome ~ running | cutoff, clustered SE
  rd <- rdrobust(y = analysis_data_west[[paste0(outcome, "_res")]],
                 x = running_var, 
                 c = threshold,
                 covs = covs, # controls
                 bwselect = "mserd", # use MSE selection criteria
                 cluster = analysis_data_west$recode_diff_wage_OR_int # integer version of RV
                 )
  
  # get sample used in RD so we can report stats (non-missing outcome and within benchmark)
  rd_sample <- !is.na(analysis_data_west[[paste0(outcome, "_res")]]) &
                ifelse(running_var <= threshold, 
                      abs(running_var - threshold) <= rd$bws["h","left"], # left bandwidth
                      abs(running_var - threshold) <= rd$bws["h","right"]) # right bandwidth
  
  # store results for later table
  results_west[[outcome]] <- list(
    rd_effect = rd$coef[3], # pull robust effect estimate, error, and pval
    rd_error = rd$se[3],
    rd_pval = rd$pv[3],
    n_effective = sum(rd_sample),
    y_mean =  mean(analysis_data_west[[outcome]][rd_sample], na.rm = TRUE),
    y_sd = sd(analysis_data_west[[outcome]][rd_sample], na.rm = TRUE)
  )
}

```

# Bonus: Matching

# Discussion and Conclusion
